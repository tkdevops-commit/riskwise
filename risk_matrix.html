<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Social Risk & Risk Management Matrix</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 18px;
      background: #f7f7f8;
      color: #222;
    }
    h2 { text-align: center; margin-bottom: 6px; }
    .container { display: flex; gap: 16px; align-items: flex-start; }
    .canvas { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 1px 6px rgba(0,0,0,0.06); }
    .controls { width: 320px; }
    .matrix-label { font-size: 13px; font-weight: 600; }
    .cell { stroke: #bdbdbd; stroke-width: 1px; cursor: pointer; }
    .cell:hover { stroke-width: 2px; transform-origin: center; }
    .tooltip {
      position: absolute; text-align: left; padding: 8px; font-size: 13px;
      background: rgba(0,0,0,0.78); color: #fff; border-radius: 6px; pointer-events: none;
      max-width: 300px;
    }
    .side-panel { background:#fff; padding:12px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.06);}
    label { display:block; margin-top:8px; font-weight:600; font-size:13px; }
    input[type="file"] { margin-top:6px; }
    textarea { width:100%; min-height:80px; resize:vertical; margin-top:6px; }
    button { margin-top:8px; padding:8px 12px; border-radius:6px; border:0; background:#1f6feb; color:#fff; cursor:pointer; }
    .legend { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .legend-item { display:flex; gap:6px; align-items:center; font-size:13px; }
    .legend-swatch { width:20px; height:14px; border-radius:3px; border:1px solid #ddd; }
    .note-list { margin-top:8px; font-size:13px; max-height:220px; overflow:auto; }
    .note-item { padding:6px; border-bottom:1px solid #f0f0f0; }
    .small { font-size:12px; color:#666; }
  </style>
</head>
<body>
  
  <h2>Social Risk & Risk Management Matrix</h2>
  <div class="container">
    <div class="canvas">
      <svg id="riskMatrix" width="700" height="560"></svg>
    </div>

    <div class="controls side-panel">
      <label>Load risks CSV (columns: severity,likelihood,summary — zero-indexed 0-4)</label>
      <input id="csvInput" type="file" accept=".csv" />
      <div class="legend">
        <div class="legend-item"><div class="legend-swatch" style="background:#d4f7dc"></div> Low</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#fefcbf"></div> Moderate</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#fed7aa"></div> Elevated</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#fca5a5"></div> High</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#b91c1c"></div> Extreme</div>
      </div>

      <label style="margin-top:12px">Selected cell</label>
      <div id="selectedCell" class="small">Click a matrix cell to view or add notes</div>

      <label>Note / Evidence</label>
      <textarea id="noteText" placeholder="Add evidence, owner, mitigation or action..."></textarea>
      <button id="saveNoteBtn">Save note to cell</button>
      <button id="exportBtn" style="background:#0b6b3a">Export notes CSV</button>

      <label style="margin-top:12px">Cell notes</label>
      <div id="notes" class="note-list"><div class="small">No notes yet</div></div>

      <div style="margin-top:14px;">
        <div class="small">Tip: Use CSV upload to populate many identified risks. Click cells to annotate and export notes for reporting.</div>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip" style="opacity:0;"></div>

<script>
  // ----- configuration -----
  const severity = [
    'Minor Discontent',
    'Disengagement',
    'Internal Friction',
    'Reputational Damage',
    'Systemic Breakdown'
  ];
  const likelihood = ['Rare', 'Unlikely', 'Possible', 'Likely', 'Imminent'];

  // risk scoring baseline
  const riskMatrix = [
    [1,2,3,4,5],
    [2,4,6,8,10],
    [3,6,9,12,15],
    [4,8,12,16,20],
    [5,10,15,20,25]
  ];

  const explanations = {
    1: "Stable environment – low social tension.",
    5: "Emerging signs of disengagement or gossip.",
    10: "Moderate mistrust forming between groups.",
    15: "High tension – potential morale breakdown.",
    20: "Reputational risk – public exposure likely.",
    25: "Systemic cultural failure – urgent intervention required."
  };

  // hold notes keyed by "r_c" (row_col)
  const cellNotes = {}; // e.g. { "4_2": [{text:"note", date:"...", owner:"..."}] }

  // SVG sizing responsive-ish
  const marginLeft = 140;
  const marginTop = 50;
  const cellCount = severity.length;
  const width = 520;
  const height = 520;
  const cellSize = width / cellCount;

  const svg = d3.select("#riskMatrix")
    .attr("width", marginLeft + width + 40)
    .attr("height", marginTop + height + 60);

  // tooltip
  const tooltip = d3.select("#tooltip");

  // color scale threshold using same bands
  const color = d3.scaleThreshold()
    .domain([5,10,15,20,25])
    .range(["#d4f7dc","#fefcbf","#fed7aa","#fca5a5","#b91c1c"]);

  // flatten matrix for data-binding
  const flat = riskMatrix.flat();

  // draw cells
  svg.selectAll("rect.cell")
    .data(flat)
    .enter()
    .append("rect")
    .attr("class","cell")
    .attr("x",(d,i) => (i % 5) * cellSize + marginLeft)
    .attr("y",(d,i) => Math.floor(i/5) * cellSize + marginTop)
    .attr("width",cellSize-1)
    .attr("height",cellSize-1)
    .attr("fill", d => color(d))
    .on("mouseover", function(event,d){
      const i = d3.select(this).datumIndex = d3.selectAll("rect.cell").nodes().indexOf(this);
      const row = Math.floor(i/5), col = i % 5;
      const score = d;
      const key = `${row}_${col}`;
      let notesHtml = "";
      if (cellNotes[key] && cellNotes[key].length) {
        notesHtml = "<br><strong>Notes:</strong><ul>" + cellNotes[key].map(n => `<li>${escapeHtml(n.text)} <span class='small'>(${n.date})</span></li>`).join("") + "</ul>";
      }
      tooltip.style("opacity",1)
        .html(`<strong>${severity[col]} / ${likelihood[row]}</strong><br>Score: ${score}<br>${explanationsWithNearest(score)}${notesHtml}`)
        .style("left",(event.pageX+12)+"px")
        .style("top",(event.pageY-10)+"px");
      d3.select(this).raise().attr("stroke","#444").attr("stroke-width",2);
    })
    .on("mouseout", function(){
      tooltip.style("opacity",0);
      d3.select(this).attr("stroke","#bdbdbd").attr("stroke-width",1);
    })
    .on("click", function(event,d){
      const nodes = d3.selectAll("rect.cell").nodes();
      const i = nodes.indexOf(this);
      const row = Math.floor(i/5), col = i % 5;
      const key = `${row}_${col}`;
      const label = `${severity[col]} / ${likelihood[row]} (score ${d})`;
      document.getElementById("selectedCell").innerText = label;
      document.getElementById("noteText").value = "";
      renderNotesListForKey(key);
      // store current selected key on window
      window.__selectedCellKey = key;
    });

  // show numbers
  svg.selectAll("text.cell-text")
    .data(flat)
    .enter()
    .append("text")
    .attr("class","cell-text")
    .attr("x",(d,i) => (i % 5) * cellSize + marginLeft + cellSize/2 )
    .attr("y",(d,i) => Math.floor(i/5) * cellSize + marginTop + cellSize/2 + 6 )
    .attr("text-anchor","middle")
    .attr("fill","#111")
    .attr("font-weight","700")
    .text(d => d);

  // x axis labels (severity across columns)
  severity.forEach((lab,i) => {
    svg.append("text")
      .attr("class","matrix-label")
      .attr("x", i*cellSize + marginLeft + cellSize/2)
      .attr("y", marginTop - 18)
      .attr("text-anchor","middle")
      .text(lab);
  });

  // y axis labels (likelihood rows)
  likelihood.forEach((lab,i) => {
    svg.append("text")
      .attr("class","matrix-label")
      .attr("x", marginLeft - 12)
      .attr("y", i*cellSize + marginTop + cellSize/2 + 6)
      .attr("text-anchor","end")
      .text(lab);
  });

  // axis titles
  svg.append("text")
    .attr("x", marginLeft + width/2)
    .attr("y", marginTop + height + 36)
    .attr("text-anchor","middle")
    .attr("font-weight","700")
    .text("Severity of Social Impact");

  svg.append("text")
    .attr("transform",`translate(${34},${marginTop + height/2}) rotate(-90)`)
    .attr("text-anchor","middle")
    .attr("font-weight","700")
    .text("Likelihood of Occurrence");

  // helper - explanation nearest bucket
  function explanationsWithNearest(score) {
    // find nearest key
    const ks = Object.keys(explanations).map(k=>parseInt(k)).sort((a,b)=>a-b);
    let nearest = ks[0];
    for (let k of ks) if (score >= k) nearest = k;
    return explanations[nearest] || "";
  }

  // escape HTML
  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  // notes rendering
  function renderNotesListForKey(key) {
    const el = document.getElementById("notes");
    el.innerHTML = "";
    if (!cellNotes[key] || cellNotes[key].length === 0) {
      el.innerHTML = "<div class='small'>No notes yet for this cell.</div>";
      return;
    }
    cellNotes[key].forEach(n => {
      const div = document.createElement("div");
      div.className = "note-item";
      div.innerHTML = `<div><strong>${escapeHtml(n.text)}</strong></div><div class="small">${n.date}</div>`;
      el.appendChild(div);
    });
  }

  // save note
  document.getElementById("saveNoteBtn").addEventListener("click", function(){
    const key = window.__selectedCellKey;
    if (!key) { alert("Select a cell first."); return; }
    const text = document.getElementById("noteText").value.trim();
    if (!text) { alert("Enter a note."); return; }
    const entry = { text: text, date: new Date().toLocaleString() };
    if (!cellNotes[key]) cellNotes[key] = [];
    cellNotes[key].push(entry);
    document.getElementById("noteText").value = "";
    renderNotesListForKey(key);
  });

  // CSV upload parsing (very simple)
  document.getElementById("csvInput").addEventListener("change", function(evt){
    const f = evt.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const txt = e.target.result;
      // expect lines like: severity,likelihood,summary
      const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      let added = 0;
      lines.forEach(line => {
        const parts = line.split(',');
        if (parts.length < 3) return;
        const s = parseInt(parts[0],10);
        const l = parseInt(parts[1],10);
        const summary = parts.slice(2).join(',').trim();
        if (isNaN(s) || isNaN(l)) return;
        if (s<0||s>4||l<0||l>4) return;
        const key = `${l}_${s}`; // note: we used row=likelihood, col=severity
        if (!cellNotes[key]) cellNotes[key] = [];
        cellNotes[key].push({ text: summary, date: new Date().toLocaleString() });
        added++;
      });
      alert(`Loaded ${added} risk rows into matrix notes.`);
    };
    reader.readAsText(f);
  });

  // export notes CSV
  document.getElementById("exportBtn").addEventListener("click", function(){
    const rows = [["likelihoodRow","severityCol","score","severityLabel","likelihoodLabel","note","date"]];
    Object.keys(cellNotes).forEach(key=>{
      const [r,c] = key.split('_').map(n=>parseInt(n,10));
      const score = riskMatrix[r][c];
      (cellNotes[key]||[]).forEach(n=>{
        rows.push([r,c,score, severity[c], likelihood[r], n.text.replace(/\n/g,' '), n.date]);
      });
    });
    if (rows.length === 1) return alert("No notes to export.");
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'matrix_notes_export.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // initial note panel empty
  renderNotesListForKey(null);

</script>
</body>
</html>
